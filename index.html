<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VideoLink ‚Äî –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∑–≤–æ–Ω–æ–∫</title>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #080c10;
      --surface: rgba(255,255,255,0.04);
      --border: rgba(255,255,255,0.08);
      --accent: #00e5ff;
      --accent2: #7b5cfa;
      --danger: #ff4d6d;
      --text: #e8edf2;
      --muted: #6b7a8d;
      --glass: rgba(8, 12, 16, 0.75);
    }

    html, body {
      height: 100%;
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--text);
      overflow: hidden;
    }

    /* ‚îÄ‚îÄ STAGE (video area) ‚îÄ‚îÄ */
    #stage {
      position: fixed;
      inset: 0;
      background: #000;
    }

    #remoteVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      opacity: 0;
      transition: opacity 0.8s ease;
    }
    #remoteVideo.active { opacity: 1; }

    /* remote placeholder */
    #remotePlaceholder {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      background: radial-gradient(ellipse at 40% 40%, #0d1a2e 0%, #080c10 70%);
      transition: opacity 0.6s ease;
    }
    #remotePlaceholder.hidden { opacity: 0; pointer-events: none; }

    .placeholder-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent2), var(--accent));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.5rem;
      position: relative;
    }
    .placeholder-avatar::after {
      content: '';
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      border: 2px solid transparent;
      background: linear-gradient(135deg, var(--accent), var(--accent2)) border-box;
      -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      animation: spin 4s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ LOCAL VIDEO (PiP) ‚îÄ‚îÄ */
    #localContainer {
      position: absolute;
      bottom: 100px;
      right: 24px;
      width: 20vw;
      min-width: 160px;
      max-width: 280px;
      aspect-ratio: 4/3;
      border-radius: 16px;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.15);
      box-shadow: 0 8px 40px rgba(0,0,0,0.6), 0 0 0 1px rgba(0,229,255,0.1);
      cursor: grab;
      transition: box-shadow 0.3s, border-color 0.3s;
      z-index: 20;
      background: #111;
    }
    #localContainer:hover {
      border-color: rgba(0,229,255,0.4);
      box-shadow: 0 8px 40px rgba(0,0,0,0.8), 0 0 20px rgba(0,229,255,0.15);
    }
    #localContainer:active { cursor: grabbing; }

    #localVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transform: scaleX(-1);
    }

    .pip-label {
      position: absolute;
      bottom: 8px;
      left: 10px;
      font-size: 0.65rem;
      font-family: 'Space Mono', monospace;
      color: rgba(255,255,255,0.7);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      pointer-events: none;
    }

    /* ‚îÄ‚îÄ OVERLAY UI ‚îÄ‚îÄ */
    #overlay {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 10;
    }

    /* top bar */
    #topBar {
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: 18px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to bottom, rgba(8,12,16,0.85) 0%, transparent 100%);
      pointer-events: none;
    }

    .logo {
      font-family: 'Space Mono', monospace;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .logo-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent);
      animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.4; transform: scale(0.7); }
    }

    #callTimer {
      font-family: 'Space Mono', monospace;
      font-size: 0.85rem;
      color: rgba(255,255,255,0.6);
      letter-spacing: 0.1em;
      display: none;
    }

    /* room ID badge */
    #roomBadge {
      font-family: 'Space Mono', monospace;
      font-size: 0.7rem;
      color: var(--muted);
      letter-spacing: 0.06em;
    }

    /* ‚îÄ‚îÄ CONTROLS BAR ‚îÄ‚îÄ */
    #controls {
      position: absolute;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 12px;
      background: var(--glass);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 60px;
      padding: 10px 18px;
      pointer-events: all;
      box-shadow: 0 4px 30px rgba(0,0,0,0.5);
    }

    .ctrl-btn {
      width: 48px; height: 48px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s ease;
      background: rgba(255,255,255,0.08);
      color: var(--text);
      position: relative;
      outline: none;
    }
    .ctrl-btn:hover {
      background: rgba(255,255,255,0.16);
      transform: scale(1.08);
    }
    .ctrl-btn.active {
      background: rgba(255,255,255,0.08);
    }
    .ctrl-btn.muted {
      background: rgba(255,77,109,0.2);
      color: var(--danger);
    }
    .ctrl-btn.end-call {
      background: var(--danger);
      color: #fff;
      width: 56px; height: 56px;
      font-size: 1.4rem;
    }
    .ctrl-btn.end-call:hover {
      background: #ff1f47;
      transform: scale(1.08);
    }
    .ctrl-btn .tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: #fff;
      font-size: 0.7rem;
      padding: 4px 10px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
      font-family: 'DM Sans', sans-serif;
    }
    .ctrl-btn:hover .tooltip { opacity: 1; }

    .ctrl-divider {
      width: 1px;
      height: 32px;
      background: var(--border);
    }

    /* ‚îÄ‚îÄ CHAT PANEL ‚îÄ‚îÄ */
    #chatPanel {
      position: absolute;
      right: 24px;
      top: 70px;
      bottom: 100px;
      width: 300px;
      background: var(--glass);
      backdrop-filter: blur(24px);
      -webkit-backdrop-filter: blur(24px);
      border: 1px solid var(--border);
      border-radius: 20px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      pointer-events: all;
      transform: translateX(340px);
      transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
      box-shadow: -4px 0 30px rgba(0,0,0,0.4);
    }
    #chatPanel.open { transform: translateX(0); }

    .chat-header {
      padding: 16px 18px;
      border-bottom: 1px solid var(--border);
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: 0.04em;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .chat-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 1rem;
      transition: color 0.2s;
    }
    .chat-close:hover { color: var(--text); }

    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.1) transparent;
    }

    .msg {
      max-width: 85%;
      padding: 8px 12px;
      border-radius: 14px;
      font-size: 0.82rem;
      line-height: 1.4;
      word-break: break-word;
      animation: msgIn 0.25s ease;
    }
    @keyframes msgIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: none; }
    }
    .msg.mine {
      background: linear-gradient(135deg, var(--accent2), #5a3fd6);
      color: #fff;
      align-self: flex-end;
      border-bottom-right-radius: 4px;
    }
    .msg.theirs {
      background: rgba(255,255,255,0.1);
      align-self: flex-start;
      border-bottom-left-radius: 4px;
    }
    .msg-meta {
      font-size: 0.65rem;
      opacity: 0.6;
      margin-top: 2px;
      font-family: 'Space Mono', monospace;
    }

    .chat-input-area {
      padding: 12px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
    }
    #msgInput {
      flex: 1;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      padding: 8px 12px;
      font-size: 0.82rem;
      font-family: 'DM Sans', sans-serif;
      outline: none;
      transition: border-color 0.2s;
    }
    #msgInput:focus { border-color: rgba(0,229,255,0.4); }
    #msgInput::placeholder { color: var(--muted); }
    .send-btn {
      width: 36px; height: 36px;
      border-radius: 10px;
      background: var(--accent);
      border: none;
      color: #000;
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .send-btn:hover { background: #33eeff; transform: scale(1.05); }

    /* ‚îÄ‚îÄ LOBBY SCREEN ‚îÄ‚îÄ */
    #lobby {
      position: fixed;
      inset: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      gap: 0;
      background: radial-gradient(ellipse at 30% 20%, #0d1a2e 0%, var(--bg) 60%);
      transition: opacity 0.6s ease, transform 0.6s ease;
    }
    #lobby.hidden {
      opacity: 0;
      transform: scale(1.03);
      pointer-events: none;
    }

    .lobby-inner {
      max-width: 420px;
      width: 90%;
      text-align: center;
    }

    .lobby-icon {
      font-size: 3.5rem;
      margin-bottom: 24px;
      display: block;
      animation: float 3s ease-in-out infinite;
    }
    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    .lobby-title {
      font-family: 'Space Mono', monospace;
      font-size: 2rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }
    .lobby-title span { color: var(--accent); }

    .lobby-sub {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 40px;
      line-height: 1.6;
    }

    .room-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 28px;
      margin-bottom: 20px;
    }

    .room-label {
      font-size: 0.7rem;
      font-family: 'Space Mono', monospace;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .room-input-row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    #roomIdInput {
      flex: 1;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      padding: 12px 16px;
      font-size: 0.9rem;
      font-family: 'Space Mono', monospace;
      outline: none;
      transition: border-color 0.2s;
      letter-spacing: 0.06em;
    }
    #roomIdInput:focus { border-color: rgba(0,229,255,0.5); }
    #roomIdInput::placeholder { color: var(--muted); font-size: 0.8rem; letter-spacing: 0; font-family: 'DM Sans'; }

    .copy-btn {
      width: 44px; height: 44px;
      border-radius: 10px;
      background: rgba(0,229,255,0.12);
      border: 1px solid rgba(0,229,255,0.25);
      color: var(--accent);
      cursor: pointer;
      font-size: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    .copy-btn:hover { background: rgba(0,229,255,0.22); }

    .join-btn {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: none;
      background: linear-gradient(135deg, var(--accent), #00b8d4);
      color: #000;
      font-size: 0.95rem;
      font-weight: 600;
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
      transition: all 0.25s;
      letter-spacing: 0.02em;
      margin-top: 16px;
    }
    .join-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,229,255,0.3);
    }
    .join-btn:active { transform: translateY(0); }

    .divider-text {
      text-align: center;
      position: relative;
      color: var(--muted);
      font-size: 0.75rem;
      margin: 6px 0;
    }
    .divider-text::before, .divider-text::after {
      content: '';
      position: absolute;
      top: 50%;
      width: 40%;
      height: 1px;
      background: var(--border);
    }
    .divider-text::before { left: 0; }
    .divider-text::after { right: 0; }

    #lobbyStatus {
      font-size: 0.82rem;
      color: var(--muted);
      min-height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      margin-top: 16px;
    }

    .spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(0,229,255,0.2);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: none;
    }
    .spinner.active { display: inline-block; }

    /* status dot */
    .status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--danger);
      display: inline-block;
      flex-shrink: 0;
    }
    .status-dot.connected { background: #00e676; animation: pulse 2s infinite; }
    .status-dot.waiting { background: #ffa726; animation: pulse 1.5s infinite; }

    /* notification badge on chat btn */
    .notif-badge {
      position: absolute;
      top: 6px; right: 6px;
      width: 8px; height: 8px;
      background: var(--accent);
      border-radius: 50%;
      display: none;
    }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: rgba(30,30,40,0.95);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 20px;
      font-size: 0.82rem;
      color: var(--text);
      backdrop-filter: blur(20px);
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
      z-index: 200;
      white-space: nowrap;
    }
    #toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* scanning animation on remote placeholder */
    .scan-line {
      position: absolute;
      left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
      opacity: 0.4;
      animation: scan 3s ease-in-out infinite;
    }
    @keyframes scan {
      0% { top: 20%; }
      50% { top: 80%; }
      100% { top: 20%; }
    }

    @media (max-width: 600px) {
      #localContainer { width: 28vw; bottom: 90px; right: 14px; }
      #chatPanel { width: 100%; right: 0; border-radius: 20px 20px 0 0; bottom: 0; }
      .ctrl-btn { width: 42px; height: 42px; font-size: 1rem; }
      .ctrl-btn.end-call { width: 48px; height: 48px; }
    }
  </style>
</head>
<body>

  <!-- LOBBY -->
  <div id="lobby">
    <div class="lobby-inner">
      <span class="lobby-icon">üì°</span>
      <h1 class="lobby-title">Video<span>Link</span></h1>
      <p class="lobby-sub">–ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π P2P-–∑–≤–æ–Ω–æ–∫.<br>–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å ID –∫–æ–º–Ω–∞—Ç—ã ‚Äî —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</p>

      <div class="room-card">
        <div class="room-label">–í–∞—à–∞ –∫–æ–º–Ω–∞—Ç–∞</div>
        <div class="room-input-row">
          <input id="roomIdInput" readonly placeholder="–ì–µ–Ω–µ—Ä–∞—Ü–∏—è...">
          <button class="copy-btn" onclick="copyRoomId()" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å">üìã</button>
        </div>
        <button class="join-btn" onclick="startWithMyRoom()">üé• –í–æ–π—Ç–∏ –≤ –º–æ—é –∫–æ–º–Ω–∞—Ç—É</button>
      </div>

      <div class="divider-text">–∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ ID –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</div>

      <div class="room-card" style="margin-top:16px;">
        <div class="room-label">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</div>
        <div class="room-input-row">
          <input id="joinIdInput" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã..." style="background:rgba(255,255,255,0.06);border:1px solid var(--border);border-radius:12px;color:var(--text);padding:12px 16px;font-size:0.9rem;font-family:'Space Mono',monospace;outline:none;flex:1;letter-spacing:0.06em;transition:border-color 0.2s;">
        </div>
        <button class="join-btn" onclick="joinWithId()" style="background:linear-gradient(135deg,var(--accent2),#5a3fd6);color:#fff;">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
      </div>

      <div id="lobbyStatus">
        <div class="spinner" id="lobbySpinner"></div>
        <span id="lobbyStatusText">–û–∂–∏–¥–∞–Ω–∏–µ...</span>
      </div>
    </div>
  </div>

  <!-- STAGE -->
  <div id="stage">
    <div id="remotePlaceholder">
      <div class="scan-line"></div>
      <div class="placeholder-avatar">üë§</div>
      <div id="waitingText" style="font-size:0.9rem;color:var(--muted);font-family:'Space Mono',monospace;letter-spacing:0.06em;">–û–ñ–ò–î–ê–ù–ò–ï –°–û–ë–ï–°–ï–î–ù–ò–ö–ê</div>
    </div>
    <video id="remoteVideo" autoplay playsinline></video>
  </div>

  <!-- LOCAL PiP -->
  <div id="localContainer">
    <video id="localVideo" autoplay muted playsinline></video>
    <div class="pip-label">–Ø</div>
  </div>

  <!-- OVERLAY -->
  <div id="overlay">
    <div id="topBar">
      <div class="logo">
        <div class="logo-dot"></div>
        VIDEOLINK
      </div>
      <div id="callTimer">00:00</div>
      <div id="roomBadge"></div>
    </div>

    <!-- CHAT PANEL -->
    <div id="chatPanel">
      <div class="chat-header">
        üí¨ –ß–∞—Ç
        <button class="chat-close" onclick="toggleChat()">‚úï</button>
      </div>
      <div id="messages"></div>
      <div class="chat-input-area">
        <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." autocomplete="off">
        <button class="send-btn" onclick="sendChat()">‚û§</button>
      </div>
    </div>

    <!-- CONTROLS -->
    <div id="controls">
      <button class="ctrl-btn" id="micBtn" onclick="toggleMic()">
        üé§
        <div class="tooltip">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</div>
      </button>
      <button class="ctrl-btn" id="camBtn" onclick="toggleCam()">
        üì∑
        <div class="tooltip">–ö–∞–º–µ—Ä–∞</div>
      </button>
      <div class="ctrl-divider"></div>
      <button class="ctrl-btn end-call" onclick="endCall()">
        üìµ
        <div class="tooltip">–ó–∞–≤–µ—Ä—à–∏—Ç—å</div>
      </button>
      <div class="ctrl-divider"></div>
      <button class="ctrl-btn" id="chatBtn" onclick="toggleChat()">
        üí¨
        <div class="tooltip">–ß–∞—Ç</div>
        <div class="notif-badge" id="notifBadge"></div>
      </button>
      <button class="ctrl-btn" id="fullBtn" onclick="toggleFullscreen()">
        ‚õ∂
        <div class="tooltip">–ü–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</div>
      </button>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast"></div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  STATE
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let peer, conn, localStream, activeCall;
let micOn = true, camOn = true;
let chatOpen = false;
let callStartTime = null;
let timerInterval = null;
let myRoomId = null;

const remoteVideo  = document.getElementById('remoteVideo');
const localVideo   = document.getElementById('localVideo');

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  INIT: Generate room ID & auto-join from URL
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function init() {
  // generate random room ID
  myRoomId = Math.random().toString(36).slice(2, 8).toUpperCase();
  document.getElementById('roomIdInput').value = myRoomId;

  // Check URL param
  const params = new URLSearchParams(location.search);
  const autoJoin = params.get('join');
  if (autoJoin) {
    document.getElementById('joinIdInput').value = autoJoin;
    setLobbyStatus('‚è≥ –ê–≤—Ç–æ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...', true);
    setTimeout(() => joinWithId(autoJoin), 800);
  }
})();

function copyRoomId() {
  const link = `${location.origin}${location.pathname}?join=${myRoomId}`;
  navigator.clipboard.writeText(link).then(() => toast('üîó –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'));
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  MEDIA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startMedia() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
  } catch(e) {
    toast('‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ/–º–∏–∫—Ä–æ—Ñ–æ–Ω—É');
    console.warn(e);
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  PEER CREATION
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function createPeer(id) {
  return new Promise((resolve, reject) => {
    const p = new Peer(id, {
      debug: 0,
      config: {
        iceServers: [
          { urls: 'stun:stun.l.google.com:19302' },
          { urls: 'stun:stun1.l.google.com:19302' }
        ]
      }
    });
    p.on('open', () => resolve(p));
    p.on('error', reject);
  });
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  START AS HOST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startWithMyRoom() {
  setLobbyStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...', true);
  await startMedia();

  try {
    peer = await createPeer('vl-' + myRoomId);
  } catch(e) {
    // ID already taken? use random
    peer = await createPeer(undefined);
    myRoomId = peer.id.replace('vl-','');
    document.getElementById('roomIdInput').value = myRoomId;
  }

  setLobbyStatus('‚úÖ –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞! –ñ–¥—ë–º —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...', false);
  document.getElementById('roomBadge').textContent = 'ID: ' + myRoomId;

  peer.on('connection', c => {
    conn = c;
    setupDataChannel(conn);
  });

  peer.on('call', incoming => {
    incoming.answer(localStream);
    activeCall = incoming;
    incoming.on('stream', stream => showRemote(stream));
    onConnected();
  });

  enterCallUI();
  showToastAndHideLobby();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  JOIN AS GUEST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function joinWithId(forcedId) {
  const raw = forcedId || document.getElementById('joinIdInput').value.trim().toUpperCase();
  if (!raw) { toast('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ ID –∫–æ–º–Ω–∞—Ç—ã'); return; }

  const targetId = raw.startsWith('VL-') ? raw : 'vl-' + raw;
  setLobbyStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ...', true);
  await startMedia();

  try {
    peer = await createPeer(undefined);
  } catch(e) {
    toast('‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); return;
  }

  document.getElementById('roomBadge').textContent = 'ID: ' + raw;

  // Data channel
  conn = peer.connect(targetId, { reliable: true });
  setupDataChannel(conn);

  conn.on('open', () => {
    // Make the call
    activeCall = peer.call(targetId, localStream);
    activeCall.on('stream', stream => showRemote(stream));
    onConnected();
  });

  conn.on('error', () => toast('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è'));

  enterCallUI();
  showToastAndHideLobby();
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  HELPERS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupDataChannel(c) {
  c.on('data', text => {
    addMessage(text, false);
    if (!chatOpen) {
      document.getElementById('notifBadge').style.display = 'block';
    }
  });
  c.on('close', () => toast('üìµ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è'));
}

function showRemote(stream) {
  remoteVideo.srcObject = stream;
  remoteVideo.classList.add('active');
  document.getElementById('remotePlaceholder').classList.add('hidden');
}

function onConnected() {
  setLobbyStatus('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ!', false);
  toast('‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è!');
  startCallTimer();
}

function enterCallUI() {
  // Controls visible
  document.getElementById('controls').style.pointerEvents = 'all';
  document.getElementById('overlay').style.pointerEvents = 'none';
}

function showToastAndHideLobby() {
  setTimeout(() => {
    document.getElementById('lobby').classList.add('hidden');
  }, 300);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CALL CONTROLS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleMic() {
  micOn = !micOn;
  localStream?.getAudioTracks().forEach(t => t.enabled = micOn);
  const btn = document.getElementById('micBtn');
  btn.textContent = micOn ? 'üé§' : 'üîá';
  btn.className = 'ctrl-btn' + (micOn ? '' : ' muted');
  btn.innerHTML += '<div class="tooltip">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</div>';
  toast(micOn ? 'üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤–∫–ª—é—á—ë–Ω' : 'üîá –ú–∏–∫—Ä–æ—Ñ–æ–Ω –≤—ã–∫–ª—é—á–µ–Ω');
}

function toggleCam() {
  camOn = !camOn;
  localStream?.getVideoTracks().forEach(t => t.enabled = camOn);
  const btn = document.getElementById('camBtn');
  btn.textContent = camOn ? 'üì∑' : 'üö´';
  btn.className = 'ctrl-btn' + (camOn ? '' : ' muted');
  btn.innerHTML += '<div class="tooltip">–ö–∞–º–µ—Ä–∞</div>';
  toast(camOn ? 'üì∑ –ö–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–µ–Ω–∞' : 'üö´ –ö–∞–º–µ—Ä–∞ –≤—ã–∫–ª—é—á–µ–Ω–∞');
}

function endCall() {
  if (activeCall) activeCall.close();
  if (conn) conn.close();
  if (peer) peer.destroy();
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  clearInterval(timerInterval);
  location.reload();
}

function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    document.getElementById('fullBtn').textContent = '‚õ∂';
  } else {
    document.exitFullscreen();
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  CHAT
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleChat() {
  chatOpen = !chatOpen;
  document.getElementById('chatPanel').classList.toggle('open', chatOpen);
  if (chatOpen) {
    document.getElementById('notifBadge').style.display = 'none';
    setTimeout(() => document.getElementById('msgInput').focus(), 350);
    // Shift local pip when chat open on desktop
    const pip = document.getElementById('localContainer');
    pip.style.right = chatOpen ? '340px' : '24px';
  } else {
    document.getElementById('localContainer').style.right = '24px';
  }
}

function sendChat() {
  const input = document.getElementById('msgInput');
  const text = input.value.trim();
  if (!text || !conn || conn.open === false) return;
  conn.send(text);
  addMessage(text, true);
  input.value = '';
}

function addMessage(text, mine) {
  const msgs = document.getElementById('messages');
  const wrap = document.createElement('div');
  wrap.style.display = 'flex';
  wrap.style.flexDirection = 'column';
  wrap.style.alignItems = mine ? 'flex-end' : 'flex-start';
  const d = document.createElement('div');
  d.className = 'msg ' + (mine ? 'mine' : 'theirs');
  d.textContent = text;
  const meta = document.createElement('div');
  meta.className = 'msg-meta';
  meta.textContent = new Date().toLocaleTimeString('ru', {hour:'2-digit', minute:'2-digit'});
  wrap.appendChild(d);
  wrap.appendChild(meta);
  msgs.appendChild(wrap);
  msgs.scrollTop = msgs.scrollHeight;
}

document.getElementById('msgInput').addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendChat(); }
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  TIMER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startCallTimer() {
  callStartTime = Date.now();
  document.getElementById('callTimer').style.display = 'block';
  timerInterval = setInterval(() => {
    const s = Math.floor((Date.now() - callStartTime) / 1000);
    const m = Math.floor(s / 60).toString().padStart(2,'0');
    const sec = (s % 60).toString().padStart(2,'0');
    document.getElementById('callTimer').textContent = `${m}:${sec}`;
  }, 1000);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LOBBY STATUS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setLobbyStatus(msg, loading) {
  document.getElementById('lobbyStatusText').textContent = msg;
  document.getElementById('lobbySpinner').className = 'spinner' + (loading ? ' active' : '');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  TOAST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  DRAGGABLE PiP
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function makeDraggable() {
  const pip = document.getElementById('localContainer');
  let dragging = false, ox, oy;
  pip.addEventListener('mousedown', e => {
    dragging = true;
    ox = e.clientX - pip.getBoundingClientRect().left;
    oy = e.clientY - pip.getBoundingClientRect().top;
    pip.style.transition = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    const x = e.clientX - ox;
    const y = e.clientY - oy;
    pip.style.left = x + 'px';
    pip.style.top = y + 'px';
    pip.style.right = 'auto';
    pip.style.bottom = 'auto';
  });
  document.addEventListener('mouseup', () => {
    dragging = false;
    pip.style.transition = '';
  });

  // Touch
  pip.addEventListener('touchstart', e => {
    const t = e.touches[0];
    dragging = true;
    ox = t.clientX - pip.getBoundingClientRect().left;
    oy = t.clientY - pip.getBoundingClientRect().top;
  }, {passive: true});
  document.addEventListener('touchmove', e => {
    if (!dragging) return;
    const t = e.touches[0];
    pip.style.left = (t.clientX - ox) + 'px';
    pip.style.top = (t.clientY - oy) + 'px';
    pip.style.right = 'auto';
    pip.style.bottom = 'auto';
  }, {passive: true});
  document.addEventListener('touchend', () => dragging = false);
})();
</script>
</body>
</html>
