<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VideoLink</title>
  <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500&family=Space+Mono:wght@700&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0d12;
      --accent: #00e5ff;
      --danger: #ff4d6d;
      --glass: rgba(10, 13, 18, 0.72);
      --border: rgba(255,255,255,0.09);
      --muted: #5a6472;
      --text: #dce3ea;
    }

    html, body { height: 100%; font-family: 'DM Sans', sans-serif; background: #000; overflow: hidden; }

    /* ‚îÄ‚îÄ REMOTE (full screen) ‚îÄ‚îÄ */
    #remoteVideo {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      background: #000;
      opacity: 0;
      transition: opacity 0.7s ease;
    }
    #remoteVideo.live { opacity: 1; }

    /* ‚îÄ‚îÄ WAITING BG ‚îÄ‚îÄ */
    #waiting {
      position: fixed;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 22px;
      background: radial-gradient(ellipse at 35% 35%, #0c1f35 0%, var(--bg) 65%);
      transition: opacity 0.5s ease;
    }
    #waiting.gone { opacity: 0; pointer-events: none; }

    .radar {
      position: relative;
      width: 110px;
      height: 110px;
    }
    .radar-ring {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 2px solid var(--accent);
      opacity: 0;
      animation: radar-expand 2.4s ease-out infinite;
    }
    .radar-ring:nth-child(2) { animation-delay: 0.8s; }
    .radar-ring:nth-child(3) { animation-delay: 1.6s; }
    @keyframes radar-expand {
      0%   { transform: scale(0.3); opacity: 0.7; }
      100% { transform: scale(1.8); opacity: 0; }
    }
    .radar-center {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2.6rem;
    }

    #waitStatus {
      font-family: 'Space Mono', monospace;
      font-size: 0.8rem;
      letter-spacing: 0.12em;
      color: var(--muted);
      text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ LOCAL PiP ‚îÄ‚îÄ */
    #pip {
      position: fixed;
      bottom: 90px;
      right: 20px;
      width: 20vw;
      min-width: 150px;
      max-width: 260px;
      aspect-ratio: 4/3;
      border-radius: 14px;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.13);
      box-shadow: 0 6px 32px rgba(0,0,0,0.65);
      z-index: 20;
      cursor: grab;
      background: #111;
      transition: border-color 0.3s, right 0.3s;
    }
    #pip:hover { border-color: rgba(0,229,255,0.35); }
    #pip:active { cursor: grabbing; }
    #localVideo {
      width: 100%; height: 100%;
      object-fit: cover;
      display: block;
      transform: scaleX(-1);
    }
    .pip-tag {
      position: absolute;
      bottom: 7px; left: 9px;
      font-size: 0.6rem;
      font-family: 'Space Mono', monospace;
      color: rgba(255,255,255,0.55);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      pointer-events: none;
    }

    /* ‚îÄ‚îÄ TOP BAR ‚îÄ‚îÄ */
    #topBar {
      position: fixed;
      top: 0; left: 0; right: 0;
      height: 56px;
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: linear-gradient(to bottom, rgba(0,0,0,0.7), transparent);
      z-index: 10;
      pointer-events: none;
    }
    .logo {
      font-family: 'Space Mono', monospace;
      font-size: 0.9rem;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .live-dot {
      width: 7px; height: 7px;
      border-radius: 50%;
      background: var(--danger);
    }
    .live-dot.on {
      background: #00e676;
      animation: blink 2s infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

    #timer {
      font-family: 'Space Mono', monospace;
      font-size: 0.82rem;
      color: rgba(255,255,255,0.55);
      letter-spacing: 0.1em;
    }

    /* ‚îÄ‚îÄ BOTTOM CONTROLS ‚îÄ‚îÄ */
    #controls {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--glass);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 9px 16px;
      z-index: 20;
    }

    .btn {
      width: 46px; height: 46px;
      border-radius: 50%;
      border: none;
      display: flex; align-items: center; justify-content: center;
      font-size: 1.15rem;
      cursor: pointer;
      transition: background 0.18s, transform 0.15s;
      background: rgba(255,255,255,0.08);
      color: var(--text);
      position: relative;
    }
    .btn:hover { background: rgba(255,255,255,0.15); transform: scale(1.07); }
    .btn.off { background: rgba(255,77,109,0.22); color: var(--danger); }
    .btn.end {
      background: var(--danger);
      color: #fff;
      width: 52px; height: 52px;
      font-size: 1.3rem;
    }
    .btn.end:hover { background: #ff1f47; }

    .btn .tip {
      position: absolute;
      bottom: calc(100% + 7px);
      left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.88);
      color: #fff;
      font-size: 0.68rem;
      padding: 3px 9px;
      border-radius: 6px;
      white-space: nowrap;
      opacity: 0; pointer-events: none;
      transition: opacity 0.18s;
    }
    .btn:hover .tip { opacity: 1; }

    .sep { width: 1px; height: 28px; background: var(--border); }

    /* ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ */
    #chatPanel {
      position: fixed;
      right: 20px;
      top: 60px;
      bottom: 80px;
      width: 290px;
      background: var(--glass);
      backdrop-filter: blur(22px);
      -webkit-backdrop-filter: blur(22px);
      border: 1px solid var(--border);
      border-radius: 18px;
      display: flex;
      flex-direction: column;
      z-index: 20;
      transform: translateX(320px);
      transition: transform 0.3s cubic-bezier(0.4,0,0.2,1);
    }
    #chatPanel.open { transform: translateX(0); }

    .ch-head {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 0.82rem;
      font-weight: 600;
      display: flex; align-items: center; justify-content: space-between;
      color: var(--text);
    }
    .ch-close { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 0.95rem; }
    .ch-close:hover { color: var(--text); }

    #messages {
      flex: 1; overflow-y: auto; padding: 12px;
      display: flex; flex-direction: column; gap: 6px;
      scrollbar-width: thin;
      scrollbar-color: rgba(255,255,255,0.08) transparent;
    }

    .msg-wrap { display: flex; flex-direction: column; }
    .msg-wrap.mine { align-items: flex-end; }
    .msg-wrap.theirs { align-items: flex-start; }

    .bubble {
      max-width: 82%;
      padding: 7px 11px;
      border-radius: 13px;
      font-size: 0.8rem;
      line-height: 1.45;
      word-break: break-word;
    }
    .mine .bubble { background: rgba(0,229,255,0.18); color: #cff8ff; border-bottom-right-radius: 3px; }
    .theirs .bubble { background: rgba(255,255,255,0.09); color: var(--text); border-bottom-left-radius: 3px; }

    .msg-time {
      font-size: 0.62rem;
      color: var(--muted);
      margin-top: 2px;
      font-family: 'Space Mono', monospace;
    }

    .ch-input {
      padding: 10px;
      border-top: 1px solid var(--border);
      display: flex; gap: 7px;
    }
    #msgInput {
      flex: 1;
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border);
      border-radius: 9px;
      color: var(--text);
      padding: 7px 11px;
      font-size: 0.8rem;
      font-family: 'DM Sans', sans-serif;
      outline: none;
    }
    #msgInput:focus { border-color: rgba(0,229,255,0.3); }
    #msgInput::placeholder { color: var(--muted); }
    .send {
      width: 34px; height: 34px;
      border-radius: 9px;
      background: var(--accent);
      border: none;
      color: #000;
      cursor: pointer;
      font-size: 0.9rem;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .send:hover { background: #33eeff; }

    .notif {
      position: absolute;
      top: 5px; right: 5px;
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--accent);
      display: none;
    }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed;
      bottom: 80px; left: 50%;
      transform: translateX(-50%) translateY(14px);
      background: rgba(20,24,30,0.94);
      border: 1px solid var(--border);
      backdrop-filter: blur(16px);
      border-radius: 10px;
      padding: 8px 18px;
      font-size: 0.8rem;
      color: var(--text);
      opacity: 0;
      transition: all 0.28s ease;
      pointer-events: none;
      z-index: 99;
      white-space: nowrap;
    }
    #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

    @media (max-width: 550px) {
      #pip { width: 30vw; bottom: 80px; right: 10px; }
      #chatPanel { width: calc(100% - 40px); }
      .btn { width: 40px; height: 40px; font-size: 1rem; }
      .btn.end { width: 46px; height: 46px; }
    }
  </style>
</head>
<body>

<video id="remoteVideo" autoplay playsinline></video>

<div id="waiting">
  <div class="radar">
    <div class="radar-ring"></div>
    <div class="radar-ring"></div>
    <div class="radar-ring"></div>
    <div class="radar-center">üì°</div>
  </div>
  <div id="waitStatus">–ü–æ–∏—Å–∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...</div>
</div>

<div id="pip">
  <video id="localVideo" autoplay muted playsinline></video>
  <div class="pip-tag">–Ø</div>
</div>

<div id="topBar">
  <div class="logo">
    <div class="live-dot" id="liveDot"></div>
    VIDEOLINK
  </div>
  <div id="timer"></div>
</div>

<div id="chatPanel">
  <div class="ch-head">
    üí¨ –ß–∞—Ç
    <button class="ch-close" onclick="toggleChat()">‚úï</button>
  </div>
  <div id="messages"></div>
  <div class="ch-input">
    <input id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
    <button class="send" onclick="sendMsg()">‚û§</button>
  </div>
</div>

<div id="controls">
  <button class="btn" id="micBtn" onclick="toggleMic()">üé§<div class="tip">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</div></button>
  <button class="btn" id="camBtn" onclick="toggleCam()">üì∑<div class="tip">–ö–∞–º–µ—Ä–∞</div></button>
  <div class="sep"></div>
  <button class="btn end" onclick="endCall()">üìµ<div class="tip">–ó–∞–≤–µ—Ä—à–∏—Ç—å</div></button>
  <div class="sep"></div>
  <button class="btn" id="chatBtn" onclick="toggleChat()">üí¨<div class="tip">–ß–∞—Ç</div><div class="notif" id="notif"></div></button>
  <button class="btn" onclick="toggleFs()">‚õ∂<div class="tip">–§—É–ª–ª—Å–∫—Ä–∏–Ω</div></button>
</div>

<div id="toast"></div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Slot system: first visitor grabs SLOT_A and waits.
// Second visitor can't grab SLOT_A ‚Üí becomes SLOT_B ‚Üí calls SLOT_A.
const SLOT_A = 'vlink-slot-alpha-001';
const SLOT_B = 'vlink-slot-beta-001';

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let peer, conn, activeCall, localStream;
let micOn = true, camOn = true, chatVisible = false;
let timerID = null;

const remoteVideo = document.getElementById('remoteVideo');
const localVideo  = document.getElementById('localVideo');

// ‚îÄ‚îÄ BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(async function boot() {
  await startMedia();
  trySlotA();
})();

// ‚îÄ‚îÄ MEDIA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startMedia() {
  try {
    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    localVideo.srcObject = localStream;
  } catch(e) {
    setStatus('‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ');
  }
}

// ‚îÄ‚îÄ SLOT A (host) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function trySlotA() {
  setStatus('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
  if (peer) { try { peer.destroy(); } catch(e){} }

  peer = new Peer(SLOT_A, { debug: 0 });

  peer.on('open', () => {
    setStatus('–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...');

    peer.on('connection', c => {
      conn = c;
      setupData(conn);
    });

    peer.on('call', incoming => {
      incoming.answer(localStream);
      activeCall = incoming;
      incoming.on('stream', s => showRemote(s));
    });
  });

  peer.on('error', err => {
    if (err.type === 'unavailable-id') {
      // Slot A taken ‚Äî become slot B
      peer.destroy();
      beSlotB();
    } else {
      setStatus('–ü–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ 3—Å...');
      setTimeout(trySlotA, 3000);
    }
  });
}

// ‚îÄ‚îÄ SLOT B (caller) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function beSlotB() {
  setStatus('–ù–∞—à—ë–ª –∫–æ–º–Ω–∞—Ç—É, –ø–æ–¥–∫–ª—é—á–∞—é—Å—å...');
  if (peer) { try { peer.destroy(); } catch(e){} }

  peer = new Peer(SLOT_B, { debug: 0 });

  peer.on('open', () => {
    conn = peer.connect(SLOT_A, { reliable: true });
    setupData(conn);

    conn.on('open', () => {
      activeCall = peer.call(SLOT_A, localStream);
      activeCall.on('stream', s => showRemote(s));
    });

    conn.on('error', () => {
      setStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –ø–æ–≤—Ç–æ—Ä...');
      setTimeout(() => { try { peer.destroy(); } catch(e){} trySlotA(); }, 2500);
    });
  });

  peer.on('error', () => {
    // Both slots busy (3rd+ person) ‚Äî wait and retry
    try { peer.destroy(); } catch(e){}
    setStatus('–û–∂–∏–¥–∞–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞...');
    setTimeout(trySlotA, 2000 + Math.random() * 2000);
  });
}

// ‚îÄ‚îÄ DATA CHANNEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupData(c) {
  c.on('data', text => {
    addMsg(text, false);
    if (!chatVisible) document.getElementById('notif').style.display = 'block';
  });
  c.on('close', () => {
    toast('üìµ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –æ—Ç–∫–ª—é—á–∏–ª—Å—è');
    remoteVideo.classList.remove('live');
    document.getElementById('waiting').classList.remove('gone');
    document.getElementById('liveDot').classList.remove('on');
    stopTimer();
    // Free up slots and wait for next person
    setTimeout(trySlotA, 1000);
  });
}

// ‚îÄ‚îÄ SHOW REMOTE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showRemote(stream) {
  remoteVideo.srcObject = stream;
  remoteVideo.classList.add('live');
  document.getElementById('waiting').classList.add('gone');
  document.getElementById('liveDot').classList.add('on');
  startTimer();
  toast('‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è');
}

// ‚îÄ‚îÄ CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleMic() {
  micOn = !micOn;
  localStream?.getAudioTracks().forEach(t => t.enabled = micOn);
  const b = document.getElementById('micBtn');
  b.className = 'btn' + (micOn ? '' : ' off');
  b.innerHTML = (micOn ? 'üé§' : 'üîá') + '<div class="tip">–ú–∏–∫—Ä–æ—Ñ–æ–Ω</div>';
}

function toggleCam() {
  camOn = !camOn;
  localStream?.getVideoTracks().forEach(t => t.enabled = camOn);
  const b = document.getElementById('camBtn');
  b.className = 'btn' + (camOn ? '' : ' off');
  b.innerHTML = (camOn ? 'üì∑' : 'üö´') + '<div class="tip">–ö–∞–º–µ—Ä–∞</div>';
}

function endCall() {
  try { activeCall?.close(); } catch(e){}
  try { conn?.close(); } catch(e){}
  try { peer?.destroy(); } catch(e){}
  localStream?.getTracks().forEach(t => t.stop());
  clearInterval(timerID);
  location.reload();
}

function toggleFs() {
  document.fullscreenElement
    ? document.exitFullscreen()
    : document.documentElement.requestFullscreen();
}

// ‚îÄ‚îÄ CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleChat() {
  chatVisible = !chatVisible;
  document.getElementById('chatPanel').classList.toggle('open', chatVisible);
  const pip = document.getElementById('pip');
  pip.style.right = chatVisible ? '318px' : '20px';
  if (chatVisible) {
    document.getElementById('notif').style.display = 'none';
    setTimeout(() => document.getElementById('msgInput').focus(), 320);
  }
}

function sendMsg() {
  const inp = document.getElementById('msgInput');
  const t = inp.value.trim();
  if (!t) return;
  if (conn?.open) {
    conn.send(t);
    addMsg(t, true);
    inp.value = '';
  } else {
    toast('‚ö†Ô∏è –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
  }
}

function addMsg(text, mine) {
  const wrap = document.createElement('div');
  wrap.className = 'msg-wrap ' + (mine ? 'mine' : 'theirs');
  const bub = document.createElement('div');
  bub.className = 'bubble';
  bub.textContent = text;
  const t = document.createElement('div');
  t.className = 'msg-time';
  t.textContent = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
  wrap.append(bub, t);
  const msgs = document.getElementById('messages');
  msgs.appendChild(wrap);
  msgs.scrollTop = msgs.scrollHeight;
}

document.getElementById('msgInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') sendMsg();
});

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let t0;
function startTimer() {
  t0 = Date.now();
  document.getElementById('timer').textContent = '00:00';
  timerID = setInterval(() => {
    const s = Math.floor((Date.now() - t0) / 1000);
    document.getElementById('timer').textContent =
      String(Math.floor(s / 60)).padStart(2,'0') + ':' + String(s % 60).padStart(2,'0');
  }, 1000);
}
function stopTimer() {
  clearInterval(timerID);
  document.getElementById('timer').textContent = '';
}

// ‚îÄ‚îÄ STATUS / TOAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(msg) {
  document.getElementById('waitStatus').textContent = msg;
}

let toastT;
function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  clearTimeout(toastT);
  toastT = setTimeout(() => el.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ DRAGGABLE PiP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const el = document.getElementById('pip');
  let drag = false, ox, oy;

  el.addEventListener('mousedown', e => {
    drag = true;
    const r = el.getBoundingClientRect();
    ox = e.clientX - r.left; oy = e.clientY - r.top;
    el.style.transition = 'none';
  });
  document.addEventListener('mousemove', e => {
    if (!drag) return;
    el.style.left = (e.clientX - ox) + 'px';
    el.style.top  = (e.clientY - oy) + 'px';
    el.style.right = 'auto'; el.style.bottom = 'auto';
  });
  document.addEventListener('mouseup', () => { drag = false; el.style.transition = ''; });

  el.addEventListener('touchstart', e => {
    const t = e.touches[0], r = el.getBoundingClientRect();
    drag = true; ox = t.clientX - r.left; oy = t.clientY - r.top;
  }, { passive: true });
  document.addEventListener('touchmove', e => {
    if (!drag) return;
    const t = e.touches[0];
    el.style.left = (t.clientX - ox) + 'px';
    el.style.top  = (t.clientY - oy) + 'px';
    el.style.right = 'auto'; el.style.bottom = 'auto';
  }, { passive: true });
  document.addEventListener('touchend', () => drag = false);
})();
</script>
</body>
</html>
